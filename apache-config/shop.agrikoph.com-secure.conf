# Apache Virtual Host Configuration for Agriko - SECURE HYBRID DEPLOYMENT
# File location: /etc/apache2/sites-available/shop.agrikoph.com.conf

# HTTP Virtual Host - Redirect to HTTPS
<VirtualHost *:80>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com
    DocumentRoot /var/www/shop
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Logs for HTTP redirects
    ErrorLog ${APACHE_LOG_DIR}/shop.agrikoph.com_http_error.log
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com_http_access.log combined
</VirtualHost>

# HTTPS Virtual Host - Main Configuration
<VirtualHost *:443>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com
    DocumentRoot /var/www/shop
    
    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shop.agrikoph.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shop.agrikoph.com/privkey.pem
    
    # Modern SSL Configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://agrikoph.com https://www.google-analytics.com; frame-ancestors 'none';"
    
    # Remove server signature
    ServerTokens Prod
    Header unset Server
    Header always set Server "Apache"
    
    # CRITICAL CHANGE: API PROXY CONFIGURATION
    # Enable required modules: a2enmod proxy proxy_http proxy_balancer lbmethod_byrequests
    
    # Proxy API requests to Node.js backend (with authentication middleware)
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # Admin API routes - HIGH SECURITY
    ProxyPass /api/admin/ http://127.0.0.1:3001/api/admin/
    ProxyPassReverse /api/admin/ http://127.0.0.1:3001/api/admin/
    
    # Analytics API routes - MEDIUM SECURITY  
    ProxyPass /api/analytics/ http://127.0.0.1:3001/api/analytics/
    ProxyPassReverse /api/analytics/ http://127.0.0.1:3001/api/analytics/
    
    # Protected APIs requiring authentication
    ProxyPass /api/graph/stats http://127.0.0.1:3001/api/graph/stats
    ProxyPassReverse /api/graph/stats http://127.0.0.1:3001/api/graph/stats
    
    ProxyPass /api/graph/sync http://127.0.0.1:3001/api/graph/sync
    ProxyPassReverse /api/graph/sync http://127.0.0.1:3001/api/graph/sync
    
    ProxyPass /api/populate-graph http://127.0.0.1:3001/api/populate-graph
    ProxyPassReverse /api/populate-graph http://127.0.0.1:3001/api/populate-graph
    
    ProxyPass /api/vectorize http://127.0.0.1:3001/api/vectorize
    ProxyPassReverse /api/vectorize http://127.0.0.1:3001/api/vectorize
    
    ProxyPass /api/test-connections http://127.0.0.1:3001/api/test-connections
    ProxyPassReverse /api/test-connections http://127.0.0.1:3001/api/test-connections
    
    ProxyPass /api/ab-testing/results http://127.0.0.1:3001/api/ab-testing/results
    ProxyPassReverse /api/ab-testing/results http://127.0.0.1:3001/api/ab-testing/results
    
    # Public API routes (rate-limited by Node.js)
    ProxyPass /api/search/ http://127.0.0.1:3001/api/search/
    ProxyPassReverse /api/search/ http://127.0.0.1:3001/api/search/
    
    ProxyPass /api/recommendations/ http://127.0.0.1:3001/api/recommendations/
    ProxyPassReverse /api/recommendations/ http://127.0.0.1:3001/api/recommendations/
    
    ProxyPass /api/reviews/ http://127.0.0.1:3001/api/reviews/
    ProxyPassReverse /api/reviews/ http://127.0.0.1:3001/api/reviews/
    
    # Catch-all for remaining API routes
    ProxyPass /api/ http://127.0.0.1:3001/api/
    ProxyPassReverse /api/ http://127.0.0.1:3001/api/
    
    # Proxy health check for Node.js backend
    <Location "/api/health">
        ProxyPass http://127.0.0.1:3001/api/health
        ProxyPassReverse http://127.0.0.1:3001/api/health
        # Optional: Restrict to internal monitoring
        # Require ip 127.0.0.1
    </Location>
    
    # Enable Compression
    <IfModule mod_deflate.c>
        # Compress HTML, CSS, JavaScript, Text, XML and fonts
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
        AddOutputFilterByType DEFLATE application/x-font
        AddOutputFilterByType DEFLATE application/x-font-opentype
        AddOutputFilterByType DEFLATE application/x-font-otf
        AddOutputFilterByType DEFLATE application/x-font-truetype
        AddOutputFilterByType DEFLATE application/x-font-ttf
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE font/opentype
        AddOutputFilterByType DEFLATE font/otf
        AddOutputFilterByType DEFLATE font/ttf
        AddOutputFilterByType DEFLATE image/svg+xml
        AddOutputFilterByType DEFLATE image/x-icon
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE application/json
        
        # Remove browser bugs (only needed for really old browsers)
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        Header append Vary User-Agent
    </IfModule>
    
    # Caching Configuration
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # Images
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/avif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
        
        # CSS, JavaScript
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"
        ExpiresByType text/javascript "access plus 1 year"
        
        # Fonts
        ExpiresByType application/x-font-ttf "access plus 1 year"
        ExpiresByType font/opentype "access plus 1 year"
        ExpiresByType application/x-font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        
        # HTML, Data
        ExpiresByType text/html "access plus 1 hour"
        ExpiresByType application/json "access plus 1 hour"
        ExpiresByType application/xml "access plus 1 hour"
        ExpiresByType text/xml "access plus 1 hour"
        
        # Manifest files
        ExpiresByType application/manifest+json "access plus 1 week"
        ExpiresByType text/cache-manifest "access plus 0 seconds"
    </IfModule>
    
    # STATIC FILE SERVING (Updated for hybrid deployment)
    <Directory /var/www/shop>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable rewrite engine
        RewriteEngine On
        
        # SECURITY: Block direct access to API-like paths that should be proxied
        RewriteCond %{REQUEST_URI} ^/api/
        RewriteCond %{REQUEST_URI} !^/api/health$
        RewriteRule ^(.*)$ - [F,L]
        
        # Handle Next.js client-side routing for static files
        # First, try to serve the file directly
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        
        # If file doesn't exist, check for .html version (Next.js static export)
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !/$
        RewriteCond %{REQUEST_URI} !\.[^./]+$
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteRule ^(.*)$ $1.html [L]
        
        # Fallback to index.html for client-side routing (EXCLUDING API routes)
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteRule ^(.*)$ /index.html [L]
        
        # Force trailing slash for directories (Next.js requirement)
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteCond %{REQUEST_URI} !/$
        RewriteRule ^(.*)$ $1/ [R=301,L]
    </Directory>
    
    # Security: Deny access to sensitive files
    <FilesMatch "\.(env|log|config|ini)$">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Next.js Static Assets Optimization
    <Directory /var/www/shop/_next>
        # Cache Next.js static assets aggressively
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
        </IfModule>
        
        # Add immutable cache header for hashed assets
        <FilesMatch "\.[a-f0-9]{8,}\.(js|css|png|jpg|jpeg|gif|webp|avif|svg|woff|woff2|ttf)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
    </Directory>
    
    # Sitemap and robots.txt optimization
    <Files "sitemap.xml">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 day"
        </IfModule>
    </Files>
    
    <Files "robots.txt">
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 week"
        </IfModule>
    </Files>
    
    # Enhanced Logging for debugging proxy issues
    ErrorLog ${APACHE_LOG_DIR}/shop.agrikoph.com_error.log
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com_access.log combined
    
    # Log proxy-specific information
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com_proxy.log "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D"
    
    # Log level for debugging (change to warn for production)
    LogLevel warn
</VirtualHost>

# Additional redirect for www subdomain
<VirtualHost *:443>
    ServerName www.shop.agrikoph.com
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shop.agrikoph.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shop.agrikoph.com/privkey.pem
    
    RewriteEngine On
    RewriteRule ^(.*)$ https://shop.agrikoph.com$1 [R=301,L]
</VirtualHost>