# Apache configuration for Next.js reverse proxy
# This replaces the static file serving configuration

<VirtualHost *:80>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com

    # Enable necessary modules (run these commands on server):
    # a2enmod proxy proxy_http proxy_wstunnel headers rewrite ssl

    # Proxy configuration for Next.js
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyVia Off

    # Handle WebSocket connections (for Next.js hot reload in dev, real-time features)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3000/$1" [P,L]

    # Proxy all requests to Next.js server
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/

    # Timeout settings for long-running requests
    ProxyTimeout 300

    # Security headers (Next.js will also add its own)
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # SSL Configuration (adjust paths as needed)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shop.agrikoph.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shop.agrikoph.com/privkey.pem

    # Modern SSL configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # HSTS (optional but recommended)
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/shop.agrikoph.com-error.log
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com-access.log combined
</VirtualHost>