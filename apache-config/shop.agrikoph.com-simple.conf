# Apache Virtual Host Configuration for Agriko - SIMPLE FULL NODE.JS PROXY
# File location: /etc/apache2/sites-available/shop.agrikoph.com.conf
# RECOMMENDED SOLUTION: Simple, secure, maintainable

# HTTP Virtual Host - Redirect to HTTPS
<VirtualHost *:80>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Logs for HTTP redirects
    ErrorLog ${APACHE_LOG_DIR}/shop.agrikoph.com_http_error.log
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com_http_access.log combined
</VirtualHost>

# HTTPS Virtual Host - Full Node.js Proxy
<VirtualHost *:443>
    ServerName shop.agrikoph.com
    ServerAlias www.shop.agrikoph.com
    
    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shop.agrikoph.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shop.agrikoph.com/privkey.pem
    
    # Modern SSL Configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # Remove server signature
    ServerTokens Prod
    Header unset Server
    Header always set Server "Apache"
    
    # SIMPLE SOLUTION: Proxy everything to Node.js
    # Enable required modules: a2enmod proxy proxy_http headers rewrite ssl
    
    ProxyPreserveHost On
    ProxyTimeout 300
    
    # Health check endpoint for monitoring
    <Location "/health">
        ProxyPass http://127.0.0.1:3000/health
        ProxyPassReverse http://127.0.0.1:3000/health
        # Optional: Restrict to internal monitoring
        # Require ip 127.0.0.1
    </Location>
    
    # Proxy all requests to Next.js application
    ProxyPass / http://127.0.0.1:3000/
    ProxyPassReverse / http://127.0.0.1:3000/
    
    # Optional: WebSocket support for development
    # RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteRule /(.*) ws://127.0.0.1:3000/$1 [P,L]
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/shop.agrikoph.com_error.log
    CustomLog ${APACHE_LOG_DIR}/shop.agrikoph.com_access.log combined
    
    # Log level for debugging
    LogLevel warn
</VirtualHost>

# Additional redirect for www subdomain
<VirtualHost *:443>
    ServerName www.shop.agrikoph.com
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shop.agrikoph.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shop.agrikoph.com/privkey.pem
    
    RewriteEngine On
    RewriteRule ^(.*)$ https://shop.agrikoph.com$1 [R=301,L]
</VirtualHost>